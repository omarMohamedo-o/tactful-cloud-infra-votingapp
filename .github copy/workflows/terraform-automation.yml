name: Terraform IaC Automation

on:
    push:
        branches: [main]
        paths:
            - "terraform/**"
    pull_request:
        branches: [main]
        paths:
            - "terraform/**"
    workflow_dispatch:
        inputs:
            action:
                description: "Terraform action to perform"
                required: true
                default: "plan"
                type: choice
                options:
                    - plan
                    - apply
                    - destroy

env:
    TF_VERSION: 1.14.0
    WORKING_DIR: ./terraform

jobs:
    terraform-checks:
        name: Terraform Validation & Security
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Terraform Format Check
              id: fmt
              run: terraform fmt -check -recursive
              continue-on-error: true

            - name: Terraform Init
              id: init
              run: terraform init -backend=false

            - name: Terraform Validate
              id: validate
              run: terraform validate -no-color

            - name: Run TFLint
              uses: terraform-linters/setup-tflint@v4

            - name: Init TFLint
              run: tflint --init

            - name: Run TFLint
              run: tflint --format compact

            - name: Terraform Security Scan with Checkov
              uses: bridgecrewio/checkov-action@master
              with:
                  directory: ${{ env.WORKING_DIR }}
                  framework: terraform
                  output_format: cli
                  soft_fail: true

            - name: Terraform Security Scan with tfsec
              uses: aquasecurity/tfsec-action@v1.0.0
              with:
                  working_directory: ${{ env.WORKING_DIR }}
                  soft_fail: true

            - name: Comment PR with validation results
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const output = `#### Terraform Format and Style ðŸ–Œ\`${{ steps.fmt.outcome }}\`
                      #### Terraform Initialization âš™ï¸\`${{ steps.init.outcome }}\`
                      #### Terraform Validation ðŸ¤–\`${{ steps.validate.outcome }}\`

                      *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: output
                      })

    terraform-plan:
        name: Terraform Plan
        runs-on: ubuntu-latest
        needs: terraform-checks
        if: github.event_name == 'pull_request' || github.event.inputs.action == 'plan'
        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Terraform Init
              run: terraform init

            - name: Terraform Plan
              id: plan
              run: |
                  terraform plan -no-color -out=tfplan
                  terraform show -no-color tfplan > plan.txt
              continue-on-error: true

            - name: Upload plan artifact
              uses: actions/upload-artifact@v4
              with:
                  name: terraform-plan
                  path: ${{ env.WORKING_DIR }}/tfplan

            - name: Comment PR with plan
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const fs = require('fs');
                      const plan = fs.readFileSync('${{ env.WORKING_DIR }}/plan.txt', 'utf8');
                      const output = `#### Terraform Plan ðŸ“–
                      <details><summary>Show Plan</summary>

                      \`\`\`terraform
                      ${plan}
                      \`\`\`

                      </details>

                      *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: output
                      })

    terraform-apply:
        name: Terraform Apply
        runs-on: ubuntu-latest
        needs: terraform-checks
        if: |
            (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
            github.event.inputs.action == 'apply'
        environment:
            name: production
        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Configure Minikube credentials
              run: |
                  # This would be replaced with actual cloud provider credentials
                  echo "Setting up cluster credentials..."

            - name: Terraform Init
              run: terraform init

            - name: Terraform Apply
              run: terraform apply -auto-approve

            - name: Verify deployment
              run: |
                  echo "Verifying infrastructure deployment..."
                  # Add verification steps

    terraform-destroy:
        name: Terraform Destroy
        runs-on: ubuntu-latest
        if: github.event.inputs.action == 'destroy'
        environment:
            name: production-destroy
        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v3
              with:
                  terraform_version: ${{ env.TF_VERSION }}

            - name: Terraform Init
              run: terraform init

            - name: Terraform Destroy
              run: terraform destroy -auto-approve

            - name: Cleanup notification
              run: echo "Infrastructure destroyed successfully"
