name: Monitoring & Health Checks

on:
    schedule:
        - cron: "*/15 * * * *" # Every 15 minutes
    workflow_dispatch:

jobs:
    health-check:
        name: Application Health Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup kubectl
              uses: azure/setup-kubectl@v3

            - name: Configure kubectl
              run: |
                  mkdir -p $HOME/.kube
                  echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config

            - name: Check pod health
              id: pod_health
              run: |
                  echo "Checking pod health..."
                  kubectl get pods -n voting-app -o json | jq -r '.items[] | select(.status.phase != "Running") | .metadata.name' > unhealthy_pods.txt

                  if [ -s unhealthy_pods.txt ]; then
                    echo "unhealthy=true" >> $GITHUB_OUTPUT
                    echo "Unhealthy pods found:"
                    cat unhealthy_pods.txt
                  else
                    echo "unhealthy=false" >> $GITHUB_OUTPUT
                    echo "All pods are healthy"
                  fi

            - name: Check service endpoints
              run: |
                  kubectl get endpoints -n voting-app

                  VOTE_READY=$(kubectl get endpoints vote -n voting-app -o jsonpath='{.subsets[*].addresses[*].ip}' | wc -w)
                  RESULT_READY=$(kubectl get endpoints result -n voting-app -o jsonpath='{.subsets[*].addresses[*].ip}' | wc -w)

                  echo "Vote service endpoints: $VOTE_READY"
                  echo "Result service endpoints: $RESULT_READY"

                  if [ "$VOTE_READY" -eq 0 ] || [ "$RESULT_READY" -eq 0 ]; then
                    echo "âŒ Some services have no ready endpoints"
                    exit 1
                  fi

            - name: Test Vote endpoint
              run: |
                  kubectl port-forward -n voting-app svc/vote 8080:80 &
                  sleep 3
                  RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/)
                  if [ "$RESPONSE" -ne 200 ]; then
                    echo "âŒ Vote endpoint failed (HTTP $RESPONSE)"
                    exit 1
                  fi
                  echo "âœ… Vote endpoint healthy"

            - name: Test Result endpoint
              run: |
                  kubectl port-forward -n voting-app svc/result 8081:4000 &
                  sleep 3
                  RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/)
                  if [ "$RESPONSE" -ne 200 ]; then
                    echo "âŒ Result endpoint failed (HTTP $RESPONSE)"
                    exit 1
                  fi
                  echo "âœ… Result endpoint healthy"

            - name: Check database connectivity
              run: |
                  echo "Checking PostgreSQL connectivity..."
                  kubectl exec -n voting-app postgresql-0 -- pg_isready -U postgres

                  echo "Checking Redis connectivity..."
                  kubectl exec -n voting-app redis-master-0 -- redis-cli ping

            - name: Generate health report
              run: |
                  echo "## Health Check Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Time**: $(date)" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Pod Status" >> $GITHUB_STEP_SUMMARY
                  kubectl get pods -n voting-app >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Services" >> $GITHUB_STEP_SUMMARY
                  kubectl get svc -n voting-app >> $GITHUB_STEP_SUMMARY

            - name: Alert on failure
              if: failure()
              run: |
                  echo "ğŸš¨ Health check failed! Manual investigation required."
                  # Add notification integration here (Slack, PagerDuty, etc.)

    performance-test:
        name: Performance & Load Testing
        runs-on: ubuntu-latest
        needs: health-check

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup kubectl
              uses: azure/setup-kubectl@v3

            - name: Configure kubectl
              run: |
                  mkdir -p $HOME/.kube
                  echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config

            - name: Install k6
              run: |
                  sudo gpg -k
                  sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
                  echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
                  sudo apt-get update
                  sudo apt-get install k6

            - name: Port forward services
              run: |
                  kubectl port-forward -n voting-app svc/vote 8080:80 &
                  kubectl port-forward -n voting-app svc/result 8081:4000 &
                  sleep 5

            - name: Run load test
              run: |
                  cat > load-test.js << 'EOF'
                  import http from 'k6/http';
                  import { check, sleep } from 'k6';

                  export let options = {
                    stages: [
                      { duration: '30s', target: 10 },
                      { duration: '1m', target: 20 },
                      { duration: '30s', target: 0 },
                    ],
                    thresholds: {
                      http_req_duration: ['p(95)<500'],
                      http_req_failed: ['rate<0.1'],
                    },
                  };

                  export default function () {
                    let voteResponse = http.post('http://localhost:8080/', 'vote=a');
                    check(voteResponse, {
                      'vote status is 200': (r) => r.status === 200,
                    });

                    let resultResponse = http.get('http://localhost:8081/');
                    check(resultResponse, {
                      'result status is 200': (r) => r.status === 200,
                    });

                    sleep(1);
                  }
                  EOF

                  k6 run load-test.js
